#include "encdec.h"

#ifndef _WIN32_WCE 
  #include <crtdbg.h>
#else
  #ifndef _ASSERTE
    #define _ASSERTE(x)
  #endif
#endif


#define CODE_PAGE_CAPACITY 128


/* **************************************************************** */
/*    Coding tables from single-byte codings to UTF-16LE            */
/* **************************************************************** */

static wchar_t s_WIN1251_UTF16[CODE_PAGE_CAPACITY] =
{
  0x402, 0x403,  0x201A, 0x453,  0x201E, 0x2026, 0x2020, 0x2021, 0x20AC, 0x2030, 0x409, 0x2039, 0x40A, 0x40C, 0x40B, 0x40F,
  0x452, 0x2018, 0x2019, 0x201C, 0x201D, 0x2022, 0x2013, 0x2014, 0x0020, 0x2122, 0x459, 0x203A, 0x45A, 0x45C, 0x45B, 0x45F,
  0xA0,  0x40E,  0x45E,  0x408,  0xA4,   0x490,  0xA6,   0xA7,   0x401,  0xA9,   0x404, 0xAB,   0xAC,	 0xAD,  0xAE,  0x407,
  0xB0,  0xB1,   0x406,  0x456,  0x491,  0xB5,   0xB6,   0xB7,   0x451,  0x2116, 0x454, 0xBB,   0x458, 0x405, 0x455, 0x457,
  0x410, 0x411,  0x412,  0x413,  0x414,  0x415,  0x416,  0x417,  0x418,  0x419,  0x41A, 0x41B,  0x41C, 0x41D, 0x41E, 0x41F,
  0x420, 0x421,  0x422,  0x423,  0x424,  0x425,  0x426,  0x427,  0x428,  0x429,  0x42A, 0x42B,  0x42C, 0x42D, 0x42E, 0x42F,
  0x430, 0x431,  0x432,  0x433,  0x434,  0x435,  0x436,  0x437,  0x438,  0x439,  0x43A, 0x43B,  0x43C, 0x43D, 0x43E, 0x43F,
  0x440, 0x441,  0x442,  0x443,  0x444,  0x445,  0x446,  0x447,  0x448,  0x449,  0x44A, 0x44B,  0x44C, 0x44D, 0x44E, 0x44F
};

static wchar_t s_KOI8R_UTF16[CODE_PAGE_CAPACITY] = 
{
  0x2500, 0x2502, 0x250C, 0x2510, 0x2514, 0x2518, 0x251C, 0x2524, 0x252C, 0x2534,
  0x253C, 0x2580, 0x2584, 0x2588, 0x258C, 0x2590, 0x2591, 0x2592, 0x2593, 0x2320,
  0x25A0, 0x2219, 0x221A, 0x2248, 0x2264, 0x2265, 0xA0,   0x2321, 0xB0,   0xB2,
  0xB7,   0xF7,   0x2550, 0x2551, 0x2552, 0x451,  0x2553, 0x2554, 0x2555, 0x2556,
  0x2557, 0x2558, 0x2559, 0x255A, 0x255B, 0x255C, 0x255D, 0x255E, 0x255F, 0x2560,
  0x2561, 0x401,  0x2562, 0x2563, 0x2564, 0x2565, 0x2566, 0x2567, 0x2568, 0x2569,
  0x256A, 0x256B, 0x256C, 0xA9,   0x44E,  0x430,  0x431,  0x446,  0x434,  0x435,
  0x444,  0x433,  0x445,  0x438,  0x439,  0x43A,  0x43B,  0x43C,  0x43D,  0x43E,
  0x43F,  0x44F,  0x440,  0x441,  0x442,  0x443,  0x436,  0x432,  0x44C,  0x44B,
  0x437,  0x448,  0x44D,  0x449,  0x447,  0x44A,  0x42E,  0x410,  0x411,  0x426,
  0x414,  0x415,  0x424,  0x413,  0x425,  0x418,  0x419,  0x41A,  0x41B,  0x41C,
  0x41D,  0x41E,  0x41F,  0x42F,  0x420,  0x421,  0x422,  0x423,  0x416,  0x412,
  0x42C,  0x42B,  0x417,  0x428,  0x42D,  0x429,  0x427,  0x42A
};

static wchar_t s_CP866_UTF16[CODE_PAGE_CAPACITY] =
{
  0x410,  0x411,  0x412,  0x413,  0x414,  0x415,  0x416,  0x417,  0x418,  0x419,
  0x41A,  0x41B,  0x41C,  0x41D,  0x41E,  0x41F,  0x420,  0x421,  0x422,  0x423,
  0x424,  0x425,  0x426,  0x427,  0x428,  0x429,  0x42A,  0x42B,  0x42C,  0x42D,
  0x42E,  0x42F,  0x430,  0x431,  0x432,  0x433,  0x434,  0x435,  0x436,  0x437,
  0x438,  0x439,  0x43A,  0x43B,  0x43C,  0x43D,  0x43E,  0x43F,  0x2591, 0x2592,
  0x2593, 0x2502, 0x2524, 0x2561, 0x2562, 0x2556, 0x2555, 0x2563, 0x2551, 0x2557,
  0x255D, 0x255C, 0x255B, 0x2510, 0x2514, 0x2534, 0x252C, 0x251C, 0x2500, 0x253C,
  0x255E, 0x255F, 0x255A, 0x2554, 0x2569, 0x2569, 0x2560, 0x2560, 0x2560, 0x2567, 
  0x2568, 0x2564, 0x2565, 0x2559, 0x2558, 0x2552, 0x2553, 0x256B, 0x256A, 0x2518,
  0x250C, 0x2588, 0x2584, 0x258C, 0x2590, 0x2580, 0x440,  0x441,  0x442,  0x443,  
  0x444,  0x445,  0x446,  0x447,  0x448,  0x449,  0x44A,  0x44B,  0x44C,  0x44D, 
  0x44E,  0x44F,  0x401,  0x451,  0x404,  0x454,  0x407,  0x457,  0x40E,  0x45E, 
  0xB0,   0x2219, 0xB7,   0x221A, 0x2116, 0xA4,   0x25A0, 0xA0
};


/* ******************************************************************* */
/*    Coding tables from UTF-16LE to single-byte codings               */
/*  Format: on 2k place is a character in UTF16, order is ascending    */
/*          on 2k+1 place is a character in single-byte coding         */
/* ******************************************************************* */

static wchar_t s_UTF16_WIN1251 [2*CODE_PAGE_CAPACITY] =
{
  0x0020, 0x0098, 0x00a0, 0x00a0, 0x00a4, 0x00a4, 0x00a6, 0x00a6, 0x00a7, 0x00a7, 0x00a9, 0x00a9, 0x00ab, 0x00ab, 0x00ac, 0x00ac, 
  0x00ad, 0x00ad, 0x00ae, 0x00ae, 0x00b0, 0x00b0, 0x00b1, 0x00b1, 0x00b5, 0x00b5, 0x00b6, 0x00b6, 0x00b7, 0x00b7, 0x00bb, 0x00bb, 
  0x0401, 0x00a8, 0x0402, 0x0080, 0x0403, 0x0081, 0x0404, 0x00aa, 0x0405, 0x00bd, 0x0406, 0x00b2, 0x0407, 0x00af, 0x0408, 0x00a3, 
  0x0409, 0x008a, 0x040a, 0x008c, 0x040b, 0x008e, 0x040c, 0x008d, 0x040e, 0x00a1, 0x040f, 0x008f, 0x0410, 0x00c0, 0x0411, 0x00c1, 
  0x0412, 0x00c2, 0x0413, 0x00c3, 0x0414, 0x00c4, 0x0415, 0x00c5, 0x0416, 0x00c6, 0x0417, 0x00c7, 0x0418, 0x00c8, 0x0419, 0x00c9, 
  0x041a, 0x00ca, 0x041b, 0x00cb, 0x041c, 0x00cc, 0x041d, 0x00cd, 0x041e, 0x00ce, 0x041f, 0x00cf, 0x0420, 0x00d0, 0x0421, 0x00d1, 
  0x0422, 0x00d2, 0x0423, 0x00d3, 0x0424, 0x00d4, 0x0425, 0x00d5, 0x0426, 0x00d6, 0x0427, 0x00d7, 0x0428, 0x00d8, 0x0429, 0x00d9, 
  0x042a, 0x00da, 0x042b, 0x00db, 0x042c, 0x00dc, 0x042d, 0x00dd, 0x042e, 0x00de, 0x042f, 0x00df, 0x0430, 0x00e0, 0x0431, 0x00e1, 
  0x0432, 0x00e2, 0x0433, 0x00e3, 0x0434, 0x00e4, 0x0435, 0x00e5, 0x0436, 0x00e6, 0x0437, 0x00e7, 0x0438, 0x00e8, 0x0439, 0x00e9, 
  0x043a, 0x00ea, 0x043b, 0x00eb, 0x043c, 0x00ec, 0x043d, 0x00ed, 0x043e, 0x00ee, 0x043f, 0x00ef, 0x0440, 0x00f0, 0x0441, 0x00f1, 
  0x0442, 0x00f2, 0x0443, 0x00f3, 0x0444, 0x00f4, 0x0445, 0x00f5, 0x0446, 0x00f6, 0x0447, 0x00f7, 0x0448, 0x00f8, 0x0449, 0x00f9, 
  0x044a, 0x00fa, 0x044b, 0x00fb, 0x044c, 0x00fc, 0x044d, 0x00fd, 0x044e, 0x00fe, 0x044f, 0x00ff, 0x0451, 0x00b8, 0x0452, 0x0090, 
  0x0453, 0x0083, 0x0454, 0x00ba, 0x0455, 0x00be, 0x0456, 0x00b3, 0x0457, 0x00bf, 0x0458, 0x00bc, 0x0459, 0x009a, 0x045a, 0x009c, 
  0x045b, 0x009e, 0x045c, 0x009d, 0x045e, 0x00a2, 0x045f, 0x009f, 0x0490, 0x00a5, 0x0491, 0x00b4, 0x2013, 0x0096, 0x2014, 0x0097, 
  0x2018, 0x0091, 0x2019, 0x0092, 0x201a, 0x0082, 0x201c, 0x0093, 0x201d, 0x0094, 0x201e, 0x0084, 0x2020, 0x0086, 0x2021, 0x0087, 
  0x2022, 0x0095, 0x2026, 0x0085, 0x2030, 0x0089, 0x2039, 0x008b, 0x203a, 0x009b, 0x20ac, 0x0088, 0x2116, 0x00b9, 0x2122, 0x0099
};

static wchar_t s_UTF16_KOI8R [2*CODE_PAGE_CAPACITY] =
{
  0x00a0, 0x009a, 0x00a9, 0x00bf, 0x00b0, 0x009c, 0x00b2, 0x009d, 0x00b7, 0x009e, 0x00f7, 0x009f, 0x0401, 0x00b3, 0x0410, 0x00e1, 
  0x0411, 0x00e2, 0x0412, 0x00f7, 0x0413, 0x00e7, 0x0414, 0x00e4, 0x0415, 0x00e5, 0x0416, 0x00f6, 0x0417, 0x00fa, 0x0418, 0x00e9, 
  0x0419, 0x00ea, 0x041a, 0x00eb, 0x041b, 0x00ec, 0x041c, 0x00ed, 0x041d, 0x00ee, 0x041e, 0x00ef, 0x041f, 0x00f0, 0x0420, 0x00f2, 
  0x0421, 0x00f3, 0x0422, 0x00f4, 0x0423, 0x00f5, 0x0424, 0x00e6, 0x0425, 0x00e8, 0x0426, 0x00e3, 0x0427, 0x00fe, 0x0428, 0x00fb, 
  0x0429, 0x00fd, 0x042a, 0x00ff, 0x042b, 0x00f9, 0x042c, 0x00f8, 0x042d, 0x00fc, 0x042e, 0x00e0, 0x042f, 0x00f1, 0x0430, 0x00c1, 
  0x0431, 0x00c2, 0x0432, 0x00d7, 0x0433, 0x00c7, 0x0434, 0x00c4, 0x0435, 0x00c5, 0x0436, 0x00d6, 0x0437, 0x00da, 0x0438, 0x00c9, 
  0x0439, 0x00ca, 0x043a, 0x00cb, 0x043b, 0x00cc, 0x043c, 0x00cd, 0x043d, 0x00ce, 0x043e, 0x00cf, 0x043f, 0x00d0, 0x0440, 0x00d2, 
  0x0441, 0x00d3, 0x0442, 0x00d4, 0x0443, 0x00d5, 0x0444, 0x00c6, 0x0445, 0x00c8, 0x0446, 0x00c3, 0x0447, 0x00de, 0x0448, 0x00db, 
  0x0449, 0x00dd, 0x044a, 0x00df, 0x044b, 0x00d9, 0x044c, 0x00d8, 0x044d, 0x00dc, 0x044e, 0x00c0, 0x044f, 0x00d1, 0x0451, 0x00a3, 
  0x2219, 0x0095, 0x221a, 0x0096, 0x2248, 0x0097, 0x2264, 0x0098, 0x2265, 0x0099, 0x2320, 0x0093, 0x2321, 0x009b, 0x2500, 0x0080, 
  0x2502, 0x0081, 0x250c, 0x0082, 0x2510, 0x0083, 0x2514, 0x0084, 0x2518, 0x0085, 0x251c, 0x0086, 0x2524, 0x0087, 0x252c, 0x0088, 
  0x2534, 0x0089, 0x253c, 0x008a, 0x2550, 0x00a0, 0x2551, 0x00a1, 0x2552, 0x00a2, 0x2553, 0x00a4, 0x2554, 0x00a5, 0x2555, 0x00a6, 
  0x2556, 0x00a7, 0x2557, 0x00a8, 0x2558, 0x00a9, 0x2559, 0x00aa, 0x255a, 0x00ab, 0x255b, 0x00ac, 0x255c, 0x00ad, 0x255d, 0x00ae, 
  0x255e, 0x00af, 0x255f, 0x00b0, 0x2560, 0x00b1, 0x2561, 0x00b2, 0x2562, 0x00b4, 0x2563, 0x00b5, 0x2564, 0x00b6, 0x2565, 0x00b7, 
  0x2566, 0x00b8, 0x2567, 0x00b9, 0x2568, 0x00ba, 0x2569, 0x00bb, 0x256a, 0x00bc, 0x256b, 0x00bd, 0x256c, 0x00be, 0x2580, 0x008b, 
  0x2584, 0x008c, 0x2588, 0x008d, 0x258c, 0x008e, 0x2590, 0x008f, 0x2591, 0x0090, 0x2592, 0x0091, 0x2593, 0x0092, 0x25a0, 0x0094
};

static wchar_t s_UTF16_CP866 [2*CODE_PAGE_CAPACITY] =
{
  0x00a0, 0x00ff, 0x00a4, 0x00fd, 0x00b0, 0x00f8, 0x00b7, 0x00fa, 0x0401, 0x00f0, 0x0404, 0x00f2, 0x0407, 0x00f4, 0x040e, 0x00f6, 
  0x0410, 0x0080, 0x0411, 0x0081, 0x0412, 0x0082, 0x0413, 0x0083, 0x0414, 0x0084, 0x0415, 0x0085, 0x0416, 0x0086, 0x0417, 0x0087, 
  0x0418, 0x0088, 0x0419, 0x0089, 0x041a, 0x008a, 0x041b, 0x008b, 0x041c, 0x008c, 0x041d, 0x008d, 0x041e, 0x008e, 0x041f, 0x008f, 
  0x0420, 0x0090, 0x0421, 0x0091, 0x0422, 0x0092, 0x0423, 0x0093, 0x0424, 0x0094, 0x0425, 0x0095, 0x0426, 0x0096, 0x0427, 0x0097, 
  0x0428, 0x0098, 0x0429, 0x0099, 0x042a, 0x009a, 0x042b, 0x009b, 0x042c, 0x009c, 0x042d, 0x009d, 0x042e, 0x009e, 0x042f, 0x009f, 
  0x0430, 0x00a0, 0x0431, 0x00a1, 0x0432, 0x00a2, 0x0433, 0x00a3, 0x0434, 0x00a4, 0x0435, 0x00a5, 0x0436, 0x00a6, 0x0437, 0x00a7, 
  0x0438, 0x00a8, 0x0439, 0x00a9, 0x043a, 0x00aa, 0x043b, 0x00ab, 0x043c, 0x00ac, 0x043d, 0x00ad, 0x043e, 0x00ae, 0x043f, 0x00af, 
  0x0440, 0x00e0, 0x0441, 0x00e1, 0x0442, 0x00e2, 0x0443, 0x00e3, 0x0444, 0x00e4, 0x0445, 0x00e5, 0x0446, 0x00e6, 0x0447, 0x00e7, 
  0x0448, 0x00e8, 0x0449, 0x00e9, 0x044a, 0x00ea, 0x044b, 0x00eb, 0x044c, 0x00ec, 0x044d, 0x00ed, 0x044e, 0x00ee, 0x044f, 0x00ef, 
  0x0451, 0x00f1, 0x0454, 0x00f3, 0x0457, 0x00f5, 0x045e, 0x00f7, 0x2116, 0x00fc, 0x2219, 0x00f9, 0x221a, 0x00fb, 0x2500, 0x00c4, 
  0x2502, 0x00b3, 0x250c, 0x00da, 0x2510, 0x00bf, 0x2514, 0x00c0, 0x2518, 0x00d9, 0x251c, 0x00c3, 0x2524, 0x00b4, 0x252c, 0x00c2, 
  0x2534, 0x00c1, 0x253c, 0x00c5, 0x2551, 0x00ba, 0x2552, 0x00d5, 0x2553, 0x00d6, 0x2554, 0x00c9, 0x2555, 0x00b8, 0x2556, 0x00b7, 
  0x2557, 0x00bb, 0x2558, 0x00d4, 0x2559, 0x00d3, 0x255a, 0x00c8, 0x255b, 0x00be, 0x255c, 0x00bd, 0x255d, 0x00bc, 0x255e, 0x00c6, 
  0x255f, 0x00c7, 0x2560, 0x00cc, 0x2560, 0x00cc, 0x2560, 0x00cc, 0x2561, 0x00b5, 0x2562, 0x00b6, 0x2563, 0x00b9, 0x2564, 0x00d1, 
  0x2565, 0x00d2, 0x2567, 0x00cf, 0x2568, 0x00d0, 0x2569, 0x00ca, 0x2569, 0x00ca, 0x256a, 0x00d8, 0x256b, 0x00d7, 0x2580, 0x00df, 
  0x2584, 0x00dc, 0x2588, 0x00db, 0x258c, 0x00dd, 0x2590, 0x00de, 0x2591, 0x00b0, 0x2592, 0x00b1, 0x2593, 0x00b2, 0x25a0, 0x00fe
};


// Finds character by UTF16LE character
// table = (s_UTF16_WIN1251 / s_UTF16_KOI8R / s_UTF16_CP866)
static unsigned char getMultiByteSymbol(wchar_t wsym, const wchar_t *table)
{
  int l = 0, r = CODE_PAGE_CAPACITY - 1, i = (l + r) / 2;

  if (wsym < 0x80)
    return (unsigned char)wsym;

  while (l + 1 < r)
  {
    if (wsym < table[2*i])
      r = i;
    else if (wsym > table[2*i])
      l = i;
    else
    {
      _ASSERTE(table[2*i + 1] < 256);
      return ((unsigned char)table[2*i + 1]);
    }
    i = (l + r) / 2;
  }

  _ASSERTE(table[2*l] == wsym || table[2*l + 2] == wsym);
  _ASSERTE(table[2*l + 1] < 256 && table[2*l + 3] < 256);

  if (table[2*l] == wsym)
    return ((unsigned char)table[2*l + 1]);
  else if (table[2*l + 3] == wsym)
    return ((unsigned char)table[2*l + 3]);
  return 0x3F;  // '?'
}

static const wchar_t* getEncodingTable(coding codePage) 
{
  switch (codePage)
  {
  case CP866:
    return s_UTF16_CP866;

  case WIN1251:
    return s_UTF16_WIN1251;

  case KOI8R:
    return s_UTF16_KOI8R;

  default:
    return 0;
  }
}

static const wchar_t* getDecodingTable(coding codePage) 
{
  switch (codePage) 
  {
  case CP866:
    return s_CP866_UTF16;

  case WIN1251:
    return s_WIN1251_UTF16;

  case KOI8R:
    return s_KOI8R_UTF16;

  default:
    return 0;
  }
}


extern void EncodeString(__in const wchar_t *wstr, __in size_t length, __in coding codePage, __out unsigned char *encodedString)
{
  const wchar_t *table = getEncodingTable(codePage);
  size_t index;

  for (index = 0; index < length; ++index)
    encodedString[index] = getMultiByteSymbol(wstr[index], table);

  encodedString[length] = '\0';
}

extern void DecodeString(__in const unsigned char *str, __in size_t length, __in coding codePage, __out wchar_t *decodedString)
{
  const wchar_t *table = getDecodingTable(codePage);
  size_t index;

  for (index = 0; index < length; ++index)
  {    
    if (str[index] >= 0x80)
      decodedString[index] = table[str[index] - 0x80];
    else
      decodedString[index] = (wchar_t)str[index];
  }

  decodedString[length] = L'\0';
}